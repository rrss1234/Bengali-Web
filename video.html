<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro TV Player</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{
  --bg:#0a0a0a;
  --card:#1a1a1a;
  --accent:#2196F3;
  --fav:#ff4b2b;
  --text:#fff;
}

*{margin:0;padding:0;box-sizing:border-box;font-family: 'Segoe UI', sans-serif}

body{
  background:var(--bg);
  color:var(--text);
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* HEADER */
.header{
  height:60px;
  display:flex;
  align-items:center;
  gap:15px;
  padding:0 20px;
  background: #111;
  border-bottom:1px solid #222;
}
.back-btn {
    font-weight: 900;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* PLAYER AREA */
.player-wrap{
  position:relative;
  width:100%;
  aspect-ratio:16/9;
  background:#000;
}
video{width:100%;height:100%; object-fit: contain;}

/* CONTROLS (Toggle style) */
.controls{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  flex-direction: column;
  justify-content:center;
  align-items:center;
  opacity:0;
  visibility: hidden;
  transition:.2s;
}
.controls.show{ opacity:1; visibility: visible; }

.mid-ctrl{ display:flex; gap:35px; align-items:center;}
.mid-ctrl i{ font-size:2.8rem; cursor:pointer; color: #fff; }

.bottom-ctrl{
  position: absolute;
  bottom: 15px;
  width: 90%;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* LIST & ACTIONS */
.fixed{ background:#000; }
.info{ padding:15px; display:flex; justify-content:space-between; align-items: center;}
.actions{
  display:flex;
  justify-content:space-around;
  padding:15px 0;
  border-top:1px solid #222;
  border-bottom:1px solid #222;
}
.actions div{ text-align:center; font-size:.75rem; cursor:pointer; color: #888;}
.actions i{ display:block; font-size:1.4rem; margin-bottom:5px; color: #fff; }
.actions div.active-filter { color: var(--accent); }
.actions div.active-filter i { color: var(--accent); }

.list{ flex:1; overflow-y:auto; padding:15px; }
.row{
  display:flex;
  align-items:center;
  gap:12px;
  background:var(--card);
  padding:10px;
  border-radius:10px;
  margin-bottom:8px;
  cursor:pointer;
  transition: 0.2s;
}
.row.active{
  background: linear-gradient(90deg, #1a1a1a 0%, #112a3d 100%);
  box-shadow: inset 0 0 15px rgba(33, 150, 243, 0.15);
}
.row.active .name { color: var(--accent); font-weight: bold; }

.logo{ 
    width:45px; 
    height:45px; 
    border-radius:6px; 
    background:#222; 
    object-fit: contain; 
    border:1px solid #333;
}
.name{ flex:1; font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
.star{ font-size:1.2rem; color:#444; padding: 5px;}
.star.active{ color:var(--fav); }
</style>
</head>

<body>

<div class="header">
  <div class="back-btn" onclick="handleBack()">
    <i class="fas fa-arrow-left"></i> BACK
  </div>
  <span id="pageLabel" style="margin-left:auto; font-size: 0.8rem; color: #666;">LIVE STREAM</span>
</div>

<div class="player-wrap" id="playerArea">
  <video id="video" playsinline></video>
  <div class="controls" id="controls">
    <div class="mid-ctrl">
        <i class="fas fa-backward" onclick="event.stopPropagation(); seek(-10)"></i>
        <i class="fas fa-play" id="pp" onclick="event.stopPropagation(); togglePlay()"></i>
        <i class="fas fa-forward" onclick="event.stopPropagation(); seek(10)"></i>
    </div>
    <div class="bottom-ctrl">
        <div id="timeDisplay" style="font-size:0.8rem;">00:00</div>
        <div style="display:flex; gap:20px;">
            <i class="fas fa-volume-up" id="volBtn" onclick="event.stopPropagation(); toggleMute()"></i>
            <i class="fas fa-expand" onclick="event.stopPropagation(); toggleFull()"></i>
        </div>
    </div>
  </div>
</div>

<div class="fixed">
  <div class="info">
    <div>
      <h3 id="title" style="font-size:1rem;">Select Channel</h3>
      <small id="count" style="color:var(--accent);">Loading...</small>
    </div>
  </div>

  <div class="actions">
    <div onclick="copyLink()"><i class="fas fa-share-nodes"></i>Share</div>
    <div id="myListTab" onclick="filterFavorites()"><i class="fas fa-star"></i>My List</div>
    <div onclick="window.open('https://t.me/bestiptvlive')"><i class="fab fa-telegram"></i>Telegram</div>
  </div>
</div>

<div class="list" id="list"></div>

<script>
const video=document.getElementById('video');
const controls=document.getElementById('controls');
const pp=document.getElementById('pp');
const volBtn=document.getElementById('volBtn');
const listArea = document.getElementById('list');
let hls=new Hls(), allChannels = [], currentUrl = "";

/* লোগো সমস্যা সমাধানের জন্য ইমেজের লিংক ঠিক করা */
const DEFAULT_LOGO = "https://i.imgur.com/8Qf6Y0L.png";

/* 1. ক্লিকে কন্ট্রোল আসা-যাওয়া */
playerArea.addEventListener('click', () => {
    controls.classList.toggle('show');
});

function togglePlay(){
  if(video.paused){ video.play(); pp.className="fas fa-pause"; }
  else{ video.pause(); pp.className="fas fa-play"; }
}

function seek(t){ video.currentTime+=t; }

function toggleMute(){
    video.muted = !video.muted;
    volBtn.className = video.muted ? "fas fa-volume-mute" : "fas fa-volume-up";
}

function toggleFull(){
    if(video.requestFullscreen) video.requestFullscreen();
    else if(video.webkitRequestFullscreen) video.webkitRequestFullscreen();
}

/* 2. BACK বাটনের কাজ */
function handleBack() {
    const label = document.getElementById('pageLabel').innerText;
    if(label === "MY LIST") {
        showAllChannels(); // My List এ থাকলে Home এ যাবে
    } else {
        history.back(); // অন্যথায় ব্রাউজার ব্যাকে যাবে
    }
}

/* 3. SHARE (Copy Link) */
function copyLink(){
  if(currentUrl){
    navigator.clipboard.writeText(currentUrl);
    alert("Channel link copied!");
  }
}

/* FAVORITE LOGIC */
const KEY="my_fav_channels";
const getFav=()=>JSON.parse(localStorage.getItem(KEY)||"[]");
const saveFav=d=>localStorage.setItem(KEY,JSON.stringify(d));

function toggleFav(channel, iconEl){
  let favs = getFav();
  const index = favs.findIndex(x => x.url === channel.url);
  if(index > -1){
    favs.splice(index, 1);
    iconEl.classList.remove('active');
  } else {
    favs.push(channel);
    iconEl.classList.add('active');
  }
  saveFav(favs);
}

function filterFavorites() {
    document.getElementById('pageLabel').innerText = "MY LIST";
    document.getElementById('myListTab').classList.add('active-filter');
    render(getFav());
}

function showAllChannels() {
    document.getElementById('pageLabel').innerText = "LIVE STREAM";
    document.getElementById('myListTab').classList.remove('active-filter');
    render(allChannels);
}

/* M3U PARSER */
const url=new URLSearchParams(location.search).get('playlist');
if(url){
    fetch(url).then(r=>r.text()).then(data=>{
      const lines=data.split('\n');
      let arr=[],c={};
      lines.forEach(l=>{
        if(l.startsWith('#EXTINF')){
          c.name=l.split(',')[1]||"Unknown";
          const m=l.match(/tvg-logo="([^"]*)"/);
          c.logo= (m && m[1]) ? m[1] : DEFAULT_LOGO;
        }else if(l.trim().startsWith('http')){
          c.url=l.trim(); arr.push({...c}); c={};
        }
      });
      allChannels = arr;
      render(allChannels);
    });
}

function render(arr){
  const favs = getFav();
  listArea.innerHTML = "";
  document.getElementById('count').innerText = "Total: " + arr.length;

  arr.forEach((c,i)=>{
    const isFav = favs.some(x => x.url === c.url);
    const d=document.createElement('div');
    d.className="row";
    d.innerHTML=`
      <img class="logo" src="${c.logo}" loading="lazy" onerror="this.src='${DEFAULT_LOGO}'">
      <div class="name">${c.name}</div>
      <i class="fas fa-star star ${isFav?'active':''}"></i>
    `;
    
    d.onclick=()=>{
      play(c.url,c.name);
      document.querySelectorAll('.row').forEach(x=>x.classList.remove('active'));
      d.classList.add('active');
    };

    d.querySelector('.star').onclick=e=>{
      e.stopPropagation();
      toggleFav(c, e.target);
    };
    
    listArea.appendChild(d);
    // Auto play first channel only on initial load
    if(i===0 && !video.src && document.getElementById('pageLabel').innerText === "LIVE STREAM") d.click();
  });
}

function play(url,name){
  currentUrl = url;
  title.innerText=name;
  if(Hls.isSupported()){
      hls.destroy(); hls=new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play());
  } else {
      video.src = url;
      video.play();
  }
  pp.className="fas fa-pause";
}

// Time update display
video.ontimeupdate = () => {
    let m = Math.floor(video.currentTime / 60);
    let s = Math.floor(video.currentTime % 60);
    document.getElementById('timeDisplay').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
};
</script>

</body>
</html>
