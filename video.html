<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast IPTV Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --primary: #00a8ff;
            --bg: #0a0a0a;
            --surface: #1e1e1e;
            --text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg); color: var(--text); }

        /* Video Container */
        .player-wrapper {
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            background: #000;
            position: relative;
            aspect-ratio: 16/9;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        video { width: 100%; height: 100%; cursor: pointer; }

        /* Fast Loading Spinner */
        .loader {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 10;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Channel Section */
        .main-container { max-width: 1000px; margin: 0 auto; padding: 15px; }
        .search-box {
            width: 100%; padding: 12px;
            background: var(--surface);
            border: 1px solid #333;
            color: #fff; border-radius: 8px;
            margin-bottom: 15px; outline: none;
        }

        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }

        .channel-card {
            background: var(--surface);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            border: 2px solid transparent;
        }
        .channel-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .channel-card.active { border-color: var(--primary); background: #252525; }

        .channel-card img {
            width: 60px; height: 60px;
            object-fit: contain;
            margin-bottom: 8px;
            background: #000;
            border-radius: 5px;
        }

        .channel-name { font-size: 0.9rem; font-weight: 500; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Scrollbar Customization */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="player-wrapper">
        <div class="loader" id="mainLoader"><div class="spinner"></div></div>
        <video id="videoPlayer" controls autoplay></video>
    </div>

    <div class="main-container">
        <input type="text" class="search-box" id="searchChannel" placeholder="চ্যানেলের নাম লিখুন...">
        <div class="channel-grid" id="channelList">
            </div>
    </div>

    <script>
        const video = document.getElementById('videoPlayer');
        const loader = document.getElementById('mainLoader');
        const channelList = document.getElementById('channelList');
        const searchInput = document.getElementById('searchChannel');
        
        let hls = null;
        let allChannels = [];

        // ১. ভিডিও প্লে করার উন্নত ফাংশন
        function playChannel(url) {
            loader.style.display = 'block';
            
            if (hls) { hls.destroy(); }

            if (url.includes('.m3u8')) {
                if (Hls.isSupported()) {
                    hls = new Hls({
                        manifestLoadingRetryDelay: 1000,
                        manifestLoadingMaxRetry: 4,
                        enableWorker: true,
                        lowLatencyMode: true
                    });
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        video.play().catch(() => console.log("Auto-play blocked"));
                        loader.style.display = 'none';
                    });
                    
                    // অটো রিকভারি যদি লিঙ্ক ক্র্যাশ করে
                    hls.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal) {
                            if (data.type === Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
                            else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError();
                            else hls.destroy();
                        }
                    });
                } else {
                    video.src = url;
                }
            } else {
                video.src = url;
            }
        }

        // ২. M3U পার্স করার আধুনিক পদ্ধতি
        async function loadPlaylist(url) {
            try {
                loader.style.display = 'block';
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.text();
                allChannels = parseM3U(data);
                displayChannels(allChannels);
            } catch (error) {
                alert("প্লেলিস্ট লোড হতে সমস্যা হচ্ছে! লিঙ্কটি সঠিক কিনা চেক করুন।");
                console.error(error);
            } finally {
                loader.style.display = 'none';
            }
        }

        function parseM3U(content) {
            const lines = content.split('\n');
            const channels = [];
            let currentChannel = null;

            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    const info = line.split(',');
                    const name = info[info.length - 1].trim();
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    currentChannel = {
                        name: name,
                        logo: logoMatch ? logoMatch[1] : 'https://via.placeholder.com/60?text=TV',
                        url: ''
                    };
                } else if (line && !line.startsWith('#')) {
                    if (currentChannel) {
                        currentChannel.url = line;
                        channels.push(currentChannel);
                        currentChannel = null;
                    }
                }
            });
            return channels;
        }

        // ৩. চ্যানেলের তালিকা দেখানো
        function displayChannels(channels) {
            channelList.innerHTML = '';
            channels.forEach((channel, index) => {
                const card = document.createElement('div');
                card.className = 'channel-card';
                card.innerHTML = `
                    <img src="${channel.logo}" onerror="this.src='https://via.placeholder.com/60?text=TV'">
                    <span class="channel-name">${channel.name}</span>
                `;
                card.onclick = () => {
                    document.querySelectorAll('.channel-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    playChannel(channel.url);
                };
                channelList.appendChild(card);
            });
        }

        // ৪. সার্চ ফিল্টার
        searchInput.oninput = () => {
            const query = searchInput.value.toLowerCase();
            const filtered = allChannels.filter(c => c.name.toLowerCase().includes(query));
            displayChannels(filtered);
        };

        // ৫. ইনিশিয়ালাইজেশন
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const m3uUrl = urlParams.get('playlist');
            if (m3uUrl) {
                loadPlaylist(m3uUrl);
            } else {
                // ডিফল্ট কোনো টেস্ট লিঙ্ক চাইলে এখানে দিতে পারেন
                // loadPlaylist('আপনার_লিঙ্ক_এখানে');
            }
        });

        // ভিডিও বাফারিং হলে লোডার দেখানো
        video.onwaiting = () => loader.style.display = 'block';
        video.onplaying = () => loader.style.display = 'none';
    </script>
</body>
</html>
