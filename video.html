<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Ultimate IPTV Player PRO</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root { --bg: #000; --card: #121212; --accent: #00E5FF; --text: #fff; }
* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Arial, sans-serif; }
body { background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

/* PLAYER */
.player-wrap { position:relative; width:100%; background:#000; aspect-ratio:16/9; flex-shrink:0; overflow:hidden; }
video { width:100%; height:100%; object-fit:contain; z-index:5; pointer-events:none; }

/* CONTROLS */
.controls-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.4); opacity:0; visibility:hidden; transition:0.3s; z-index:100; display:flex; flex-direction:column; justify-content:flex-end; }
.controls-overlay.show { opacity:1; visibility:visible; }

.bottom-bar { padding:10px 15px; background:linear-gradient(transparent, rgba(0,0,0,0.9)); display:flex; justify-content:space-between; align-items:center; }

.right-side { display:flex; gap:20px; }
.right-side i { font-size:1.3rem; cursor:pointer; color:#fff; }

/* POPUP MENU */
.pop-menu {
    position:absolute;
    background:rgba(25,25,25,0.98);
    border:1px solid #333;
    border-radius:10px;
    display:flex;
    flex-direction:column;
    z-index:200;
    min-width:160px;
    box-shadow:0 10px 25px rgba(0,0,0,0.8);
    overflow:hidden;
    opacity:0;
    transform:scale(0.9);
    transition:0.2s ease;
    pointer-events:none;
}
.pop-menu.show {
    opacity:1;
    transform:scale(1);
    pointer-events:auto;
}
.pop-menu button {
    background:none;
    border:none;
    color:white;
    padding:12px 15px;
    cursor:pointer;
    border-bottom:1px solid #222;
    text-align:left;
    font-size:14px;
}
.pop-menu button:hover {
    background:var(--accent);
    color:#000;
}

/* INFO */
.info { padding:12px 15px; display:flex; justify-content:space-between; align-items:center; background:#080808; border-bottom:1px solid #1a1a1a; }
.mini-logo { width:45px; height:45px; border-radius:8px; object-fit:cover; }

/* LIST */
.list { flex:1; overflow-y:auto; padding:12px; background:var(--bg); padding-bottom:80px; }
.row { display:flex; align-items:center; gap:15px; background:var(--card); padding:12px; border-radius:12px; margin-bottom:10px; border:1px solid #1a1a1a; }
.row.active { border-color:var(--accent); background:rgba(0,229,255,0.05); }
.list-logo { width:45px; height:45px; border-radius:8px; object-fit:cover; }
.name { flex:1; font-size:1rem; color:#fff; }
</style>
</head>
<body>

<div class="player-wrap" id="playerArea">
    <video id="video" playsinline crossorigin="anonymous"></video>

    <div class="pop-menu" id="popMenu"></div>

    <div class="controls-overlay" id="controls">
        <div class="bottom-bar">
            <div>
                <i class="fas fa-play" id="pp" onclick="togglePlay(event)"></i>
                <i class="fas fa-redo" style="margin-left:20px;" onclick="location.reload()"></i>
            </div>
            <div class="right-side">
                <i class="fas fa-sliders-h" onclick="showScalingMenu(event)"></i>
                <i class="fas fa-cog" onclick="showQualityMenu(event)"></i>
                <i class="fas fa-expand" onclick="toggleFull(event)"></i>
            </div>
        </div>
    </div>
</div>

<div class="info">
    <div style="display:flex; align-items:center; gap:12px;">
        <img id="currentLogo" class="mini-logo" src="https://i.imgur.com/8Qf6Y0L.png">
        <div>
            <h3 id="title" style="font-size:16px;">Select Channel</h3>
            <small style="color:var(--accent); font-weight:bold;">LIVE STREAM</small>
        </div>
    </div>
    <div id="count" style="font-size:13px; color:var(--accent);">0 CH</div>
</div>

<div class="list" id="list"></div>

<script>
const video=document.getElementById('video'),
playerArea=document.getElementById('playerArea'),
popMenu=document.getElementById('popMenu'),
controls=document.getElementById('controls'),
listArea=document.getElementById('list');

let hls=new Hls(), allChannels=[];

/* ðŸ”¥ Dynamic Popup Position Fix */
function showPopup(e, html){
    e.stopPropagation();

    popMenu.innerHTML = html;
    popMenu.classList.add('show');

    const btnRect = e.target.getBoundingClientRect();
    const playerRect = playerArea.getBoundingClientRect();

    popMenu.style.top = (btnRect.top - playerRect.top - popMenu.offsetHeight - 10) + "px";
    popMenu.style.left = (btnRect.left - playerRect.left - 70) + "px";
}

document.addEventListener("click", ()=> popMenu.classList.remove("show"));

function showScalingMenu(e){
    showPopup(e, `
        <button onclick="setScaling('contain')">Fit Screen</button>
        <button onclick="setScaling('cover')">Zoom to Screen</button>
        <button onclick="setScaling('fill')">Stretch</button>
    `);
}

function showQualityMenu(e){
    let html = `<button onclick="setQuality(-1)">Auto Quality</button>`;
    if(hls.levels){
        hls.levels.forEach((l,i)=>{
            html += `<button onclick="setQuality(${i})">${l.height || i}p</button>`;
        });
    }
    showPopup(e, html);
}

function setScaling(t){
    video.style.objectFit=t;
    popMenu.classList.remove("show");
}

function setQuality(i){
    hls.currentLevel=i;
    popMenu.classList.remove("show");
}

function togglePlay(e){
    e.stopPropagation();
    video.paused ? video.play() : video.pause();
}

function toggleFull(e){
    e.stopPropagation();
    if(!document.fullscreenElement){
        playerArea.requestFullscreen();
    }else{
        document.exitFullscreen();
    }
}

/* Controls toggle */
playerArea.onclick=()=>{
    controls.classList.toggle('show');
};

/* Playlist Loader */
const playlistUrl = new URLSearchParams(location.search).get('playlist');
if(playlistUrl){
fetch(playlistUrl).then(r=>r.text()).then(data=>{
let lines=data.split('\n'), c={};
lines.forEach(l=>{
if(l.startsWith('#EXTINF')){
c.name=l.split(',')[1]?.trim();
c.logo=l.match(/tvg-logo="([^"]*)"/)?.[1];
}else if(l.startsWith('http')){
c.url=l.trim();
allChannels.push({...c});
c={};
}});
render();
if(allChannels[0]) play(allChannels[0].url, allChannels[0].name, allChannels[0].logo);
});
}

function play(url,name,logo){
document.getElementById('title').innerText=name;
document.getElementById('currentLogo').src=logo||"https://i.imgur.com/8Qf6Y0L.png";

if(url.includes('.m3u8')){
hls.destroy();
hls=new Hls();
hls.loadSource(url);
hls.attachMedia(video);
hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play());
}else{
video.src=url;
video.play();
}
render();
}

function render(){
listArea.innerHTML="";
document.getElementById('count').innerText=allChannels.length+" CH";
allChannels.forEach(ch=>{
const d=document.createElement('div');
d.className='row';
d.innerHTML=`<img src="${ch.logo}" class="list-logo" onerror="this.src='https://i.imgur.com/8Qf6Y0L.png'"><div class="name">${ch.name}</div>`;
d.onclick=()=>play(ch.url,ch.name,ch.logo);
listArea.appendChild(d);
});
}
</script>
</body>
</html>
